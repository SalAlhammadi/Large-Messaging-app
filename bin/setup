#!/bin/bash
#
# Script for ejabberd autoconfiguration on local machine
#
# @see Here are project requirements for a full blown compile
#      - erlang (v18.0 used during latest compile)
#      - gcc, autotools, binutils (for dealing with some compile stuff)


# Configuration settings
DIR_SRC=/home/ben/lavori/ejabberd.server/ejabberd
DIR_TARGET=/opt/ejabberd

DEBUG=--enable-debug
#DEBUG=--disable-debug
ENABLE_TOOLS=--enable-tools


# Business logic
printline() {
    COLS=$(tput cols)
    for ((I=0; I<COLS; I++));do printf "="; done; echo
}
keypress() {
    echo -n "any key to continue..."
    read -n 1 junk
}
init() {
    echo -e "\nInstallation dir cleanup ($DIR_TARGET)"
    printline
    rm -rf $DIR_TARGET/*
    ls -la $DIR_TARGET/
    echo -e ""
}
clean() {
    echo "Source code cleanup"
    printline
    #make clean # Automatically executed in distclean
    make distclean
    echo "Cleanup completed"
}
configure() {
    echo -e "\nAutogen"
    printline
    echo -n "..."
    ./autogen.sh
    echo "done."
    keypress
    echo -e "\nConfigure"
    printline
    ./configure --prefix=$DIR_TARGET            \
                --exec-prefix=$DIR_TARGET       \
                --sbindir=$DIR_TARGET/bin       \
                --sysconfdir=$DIR_TARGET/conf   \
                --datarootdir=$DIR_TARGET       \
                --docdir=$DIR_TARGET/doc        \
                --localstatedir=$DIR_TARGET     \
                --enable-pgsql                  \
                --enable-user=ben               \
                --enable-group=users            \
                $ENABLE_TOOLS $DEBUG
}
make_ejabberd() {
    echo -e "\nCompiling"
    printline
    make
}
install_ejabberd() {
    echo -e "\nInstallation"
    printline
    make install
    install_patch_ejabberd
}
# Patching installation to carefully match ejabberd binary installer directories
install_patch_ejabberd() {
    # Database dir
    mkdir $DIR_TARGET/database
    # etc <-> conf directory
    mv    $DIR_TARGET/conf/ejabberd/* $DIR_TARGET/conf/
    rmdir $DIR_TARGET/conf/ejabberd
    # Log dir
    rmdir $DIR_TARGET/log/ejabberd
    mv    $DIR_TARGET/log $DIR_TARGET/logs
    # Lock directory
    rmdir $DIR_TARGET/lock/ejabberdctl
}

cd $DIR_SRC >/dev/null 2>&1
OPTION=$1
case $OPTION in
    init)
        init
        ;;
    clean)
        clean
        ;;
    make)
        clean
        configure
        make_ejabberd
        ;;
    install)
        install_ejabberd
        ;;
    all)
        init
        clean
        keypress
        configure
        keypress
        make_ejabberd
        keypress
        install_ejabberd
        ;;
    *)
        echo -e "\nUsage:     [NOTE: Run this script from GIT source code dir $DIR_SRC]"
        echo -e "    '`basename $0` [option]' "
        echo -e "              init    Init installation directory (wipe it)"
        echo -e "              clean   Clean ejabberd source code and configure options"
        echo -e "              make    Clean/Configure/Make ejabberd source code"
        echo -e "              install install ejabberd"
        echo -e "              all     init+clean+make+install"
        echo -e ""
        cd - >/dev/null 2>&1
        exit 1
        ;;
esac
cd - >/dev/null 2>&1
